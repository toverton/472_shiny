---
title: "nnt"
author: "Alyaqadhan Alfahdi"
date: "2024-03-04"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
final_df <- read.csv("C:/Users/alyaq/Desktop/spring2024/stat472/472_shiny/alec/final_df.csv") 
```

#Random Forests and Gradient Boosting Machines (GBM)
#Support Vector Machines (SVM)
#Long Short-Term Memory (LSTM) Networks


```{r}
library(tidyverse)
library(lubridate)
library(keras)
library(forecast)
```


```{r}
df <- final_df %>%
  mutate(date = ymd(date),  
         year = year(date))  

daily_trends <- df %>%
  group_by(date) %>%
  summarise(total_killed = sum(n_killed),
            total_injured = sum(n_injured),
            total_incidents = total_killed + total_injured) %>%
  ungroup()  

```




```{r}
# Splitting 
training <- daily_trends %>%filter(date >= as.Date("2014-01-01") & date < as.Date("2017-01-01"))
testing <- daily_trends %>%filter(date >= as.Date("2017-01-01") & date <= as.Date("2017-12-31"))


```


```{r}
train_X <- training[, -which(names(training) %in% c("date", "total_incidents"))]
train_y <- training[["total_incidents"]]
test_X <- testing[, -which(names(testing) %in% c("date", "total_incidents"))]
test_y <- testing[["total_incidents"]]
```



```{r}
#scaling
train_X <- scale(train_X)
test_X <- scale(test_X, center = attr(train_X, "scaled:center"), scale = attr(train_X, "scaled:scale"))

# Reshaping 3D [samples, timesteps, features]
dim(train_X) <- c(nrow(train_X), 1, ncol(train_X))
dim(test_X) <- c(nrow(test_X), 1, ncol(test_X))

cat("Shapes:\n")
cat("Train_X:", dim(train_X), "\n")
cat("Train_y:", length(train_y), "\n")
cat("Test_X:", dim(test_X), "\n")
cat("Test_y:", length(test_y), "\n")
```





```{r}
#model

model <- keras_model_sequential() %>%
  layer_lstm(units = 50, activation = 'relu', input_shape = c(1, ncol(train_X))) %>%
  layer_dense(units = 1)


model %>% compile(
  loss = 'mean_squared_error',
  optimizer = optimizer_adam(),
  metrics = c('mean_absolute_error')
)

```



```{r}
history <- model %>% fit(
  train_X, train_y,
  epochs = 200,
  batch_size = 32,
  validation_split = 0.2,
  verbose = 2
)
```




```{r}
predictions <- model %>% predict(X_test)

predictions_rescaled <- predictions * sd(daily_trends$total_incidents) + mean(daily_trends$total_incidents)
y_test_rescaled <- y_test * sd(daily_trends$total_incidents) + mean(daily_trends$total_incidents)

```

```{r}
plot(y_test_rescaled, type = 'l', col = 'red')
lines(predictions_rescaled, col = 'blue')
```

```{r}

valid_indices <- !is.na(predictions_vector) & !is.na(actual_vector)
predictions_filtered <- predictions_vector[valid_indices]
actual_filtered <- actual_vector[valid_indices]

mae <- mean(abs(predictions_filtered - actual_filtered))

rmse <- sqrt(mean((predictions_filtered - actual_filtered)^2))

cat("MAE:", mae, "\nRMSE:", rmse, "\n")


```













```{r}
library(ggplot2)

testing_df <- data.frame(date = testing$date, total_incidents = y_test_rescaled)

forecast_df <- data.frame(date = testing$date, forecast = predictions_rescaled)

all_actuals_df <- rbind(
  data.frame(date = training$date, total_incidents = training$total_incidents),
  testing_df
)


```


```{r}
ggplot() +
  geom_point(data = all_actuals_df, aes(x = date, y = total_incidents), color = 'gray', alpha = 0.5) +
  
  geom_point(data = testing_df, aes(x = date, y = total_incidents), color = 'red') +
  
  geom_line(data = forecast_df, aes(x = date, y = forecast), color = 'blue', linetype = "dashed") +
  
  geom_point(data = forecast_df, aes(x = date, y = forecast), color = 'blue') +
  
  labs(title = "Actual vs. Forecast Total Incidents Across All Time",
       x = "Date", y = "Total Incidents",
       caption = "Gray: Actual data for all time\nRed: Actual data for testing period\nBlue dashed: Forecasted data") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") # Hide legend due to explicit caption
```







```{r}
library(ggplot2)

ggplot() +
  # Plot all actual incidents over time as a line for context
  geom_line(data = all_actuals_df, aes(x = date, y = total_incidents), color = 'gray', alpha = 0.5) +
  
  # Highlight actual incidents in the testing set with a line
  geom_line(data = testing_df, aes(x = date, y = total_incidents), color = 'red') +
  
  # Overlay forecasted data for the testing period with a dashed line
  geom_line(data = forecast_df, aes(x = date, y = forecast), color = 'blue', linetype = "dashed") +
  
  # Add titles, labels, and customize the theme
  labs(title = "Actual vs. Forecast Total Incidents Across All Time",
       x = "Date", y = "Total Incidents",
       caption = "Gray: Historical actual data\nRed: Actual data for testing period\nBlue dashed: Forecasted data") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") # Hide legend due to explicit caption

```












