---
title: "nnt"
author: "Alyaqadhan Alfahdi"
date: "2024-03-04"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
final_df <- read.csv("C:/Users/alyaq/Desktop/spring2024/stat472/472_shiny/alec/final_df.csv") 
```

#Random Forests and Gradient Boosting Machines (GBM)
#Support Vector Machines (SVM)
#Long Short-Term Memory (LSTM) Networks


```{r}
library(tidyverse)
library(lubridate)
library(keras)
library(forecast)
```


```{r}
df <- final_df %>%
  mutate(date = ymd(date),  
         year = year(date))  

daily_trends <- df %>%
  group_by(date) %>%
  summarise(total_killed = sum(n_killed),
            total_injured = sum(n_injured),
            total_incidents = total_killed) %>%
  ungroup()  

```




```{r}
# Splitting 
training <- daily_trends %>%filter(date >= as.Date("2014-01-01") & date < as.Date("2017-01-01"))
testing <- daily_trends %>%filter(date >= as.Date("2017-01-01") & date <= as.Date("2017-12-31"))


```


```{r}
train_X <- training[, -which(names(training) %in% c("date", "total_incidents"))]
train_y <- training[["total_incidents"]]
test_X <- testing[, -which(names(testing) %in% c("date", "total_incidents"))]
test_y <- testing[["total_incidents"]]
```



```{r}
#scaling
train_X <- scale(train_X)
test_X <- scale(test_X, center = attr(train_X, "scaled:center"), scale = attr(train_X, "scaled:scale"))

train_y_scaled <- scale(train_y)
test_y_scaled <- scale(test_y, center = attr(train_y_scaled, "scaled:center"), scale = attr(train_y_scaled, "scaled:scale"))

# Reshaping 3D [samples, timesteps, features]
dim(train_X) <- c(nrow(train_X), 1, ncol(train_X))
dim(test_X) <- c(nrow(test_X), 1, ncol(test_X))

cat("Shapes:\n")
cat("Train_X:", dim(train_X), "\n")
cat("Train_y:", length(train_y), "\n")
cat("Test_X:", dim(test_X), "\n")
cat("Test_y:", length(test_y), "\n")
```





```{r}
#model

model <- keras_model_sequential() %>%
  layer_lstm(units = 50, activation = 'relu', input_shape = c(1, 2)) %>%
  layer_dense(units = 1)


model %>% compile(
  loss = 'mean_squared_error',
  optimizer = optimizer_adam(),
  metrics = c('mean_absolute_error')
)

```



```{r}
history <- model %>% fit(
  train_X, train_y_scaled,
  epochs = 100,
  batch_size = 32,
  validation_split = 0.2,
  verbose = 2
)
```






```{r}
predictions <- model %>% predict(test_X)

evaluate <- model %>% evaluate(test_X, test_y_scaled)
evaluate
```





```{r}
original_mean <- attr(train_y_scaled, "scaled:center")
original_sd <- attr(train_y_scaled, "scaled:scale")
predictions_rescaled <- predictions * original_sd + original_mean

```



```{r}
train_X <- training[, -which(names(training) %in% c("date", "total_incidents"))]
train_y <- training[["total_incidents"]]
test_X <- testing[, -which(names(testing) %in% c("date", "total_incidents"))]
test_y <- testing[["total_incidents"]]
```

```{r}
plot(predictions_rescaled, type = 'l')
#lines(test_y, col = 'red')
```

```{r}
mae <- mean(abs(predictions_rescaled - test_y))

rmse <- sqrt(mean((predictions_rescaled - test_y)^2))

cat("MAE:", mae, "\nRMSE:", rmse, "\n")
```





















```{r}
library(ggplot2)

testing_df <- data.frame(date = testing$date, total_incidents = test_y)

forecast_df <- data.frame(date = testing$date, forecast = predictions_rescaled)

all_actuals_df <- rbind(
  data.frame(date = training$date, total_incidents = training$total_incidents),
  testing_df
)


```


```{r}
ggplot() +
  geom_point(data = all_actuals_df, aes(x = date, y = total_incidents), color = 'gray', alpha = 0.5) +
  
  geom_point(data = testing_df, aes(x = date, y = total_incidents), color = 'red') +
  
  geom_line(data = forecast_df, aes(x = date, y = forecast), color = 'blue', linetype = "dashed") +
  
  geom_point(data = forecast_df, aes(x = date, y = forecast), color = 'blue') +
  
  labs(title = "Actual vs. Forecast Total Incidents Across All Time",
       x = "Date", y = "Total Incidents",
       caption = "Gray: Actual data for all time\nRed: Actual data for testing period\nBlue dashed: Forecasted data") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") # Hide legend due to explicit caption
```







```{r}
library(ggplot2)

ggplot() +
  # Plot all actual incidents over time as a line for context
  geom_line(data = all_actuals_df, aes(x = date, y = total_incidents), color = 'gray', alpha = 0.5) +
  
  # Highlight actual incidents in the testing set with a line
  geom_line(data = testing_df, aes(x = date, y = total_incidents), color = 'red') +
  
  # Overlay forecasted data for the testing period with a dashed line
  geom_line(data = forecast_df, aes(x = date, y = forecast), color = 'blue', linetype = "dashed") +
  
  # Add titles, labels, and customize the theme
  labs(title = "Actual vs. Forecast Total Incidents Across All Time",
       x = "Date", y = "Total Incidents",
       caption = "Gray: Historical actual data\nRed: Actual data for testing period\nBlue dashed: Forecasted data") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") # Hide legend due to explicit caption

```


```{r}
results <- data.frame(Time = seq_along(test_y),
                      Actual = test_y,
                      Forecast = predictions_rescaled)

# Plot using ggplot
gg <- ggplot(results, aes(x = Time)) +
  geom_line(aes(y = Actual, color = "Actual")) +
  geom_line(aes(y = Forecast, color = "Forecast")) +
  labs(title = "Forecast vs Actual Values",
       x = "Time",
       y = "Value",
       color = "Legend") +
  theme_minimal() +
  scale_color_manual(values = c("Actual" = "blue", "Forecast" = "red"))

# Display the plot
print(gg)
```





```{r}
ggplot() + geom_line(aes(x = training$date, y = training$total_incidents, 
                         color = "Training" )) + 
  geom_line(aes(x = testing$date, y = predictions_rescaled, 
                         color = "Forecasted")) + 
  geom_line(aes(x = testing$date, y = testing$total_incidents,
                color = "Observed"), alpha = 0.5) + 
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        axis.line = element_line(colour = "black"),
        legend.title=element_blank()) +
  scale_color_manual(values = c("black", "darkgray", "dodgerblue2")) +
  labs(x = "Date", y = "Total Fatalities")
```





